// src/composables/useVuetifyColors.js

// Source: Vuetify 3 Material Design Palette
const vuetifyColors = {
  'red-lighten-5': '#FFEBEE', 'red-lighten-4': '#FFCDD2', 'red-lighten-3': '#EF9A9A', 'red-lighten-2': '#E57373', 'red-lighten-1': '#EF5350', 'red': '#F44336', 'red-darken-1': '#E53935', 'red-darken-2': '#D32F2F', 'red-darken-3': '#C62828', 'red-darken-4': '#B71C1C',
  'pink-lighten-5': '#FCE4EC', 'pink-lighten-4': '#F8BBD0', 'pink-lighten-3': '#F48FB1', 'pink-lighten-2': '#F06292', 'pink-lighten-1': '#EC407A', 'pink': '#E91E63', 'pink-darken-1': '#D81B60', 'pink-darken-2': '#C2185B', 'pink-darken-3': '#AD1457', 'pink-darken-4': '#880E4F',
  'purple-lighten-5': '#F3E5F5', 'purple-lighten-4': '#E1BEE7', 'purple-lighten-3': '#CE93D8', 'purple-lighten-2': '#BA68C8', 'purple-lighten-1': '#AB47BC', 'purple': '#9C27B0', 'purple-darken-1': '#8E24AA', 'purple-darken-2': '#7B1FA2', 'purple-darken-3': '#6A1B9A', 'purple-darken-4': '#4A148C',
  'deep-purple-lighten-5': '#EDE7F6', 'deep-purple-lighten-4': '#D1C4E9', 'deep-purple-lighten-3': '#B39DDB', 'deep-purple-lighten-2': '#9575CD', 'deep-purple-lighten-1': '#7E57C2', 'deep-purple': '#673AB7', 'deep-purple-darken-1': '#5E35B1', 'deep-purple-darken-2': '#512DA8', 'deep-purple-darken-3': '#4527A0', 'deep-purple-darken-4': '#311B92',
  'indigo-lighten-5': '#E8EAF6', 'indigo-lighten-4': '#C5CAE9', 'indigo-lighten-3': '#9FA8DA', 'indigo-lighten-2': '#7986CB', 'indigo-lighten-1': '#5C6BC0', 'indigo': '#3F51B5', 'indigo-darken-1': '#3949AB', 'indigo-darken-2': '#303F9F', 'indigo-darken-3': '#283593', 'indigo-darken-4': '#1A237E',
  'blue-lighten-5': '#E3F2FD', 'blue-lighten-4': '#BBDEFB', 'blue-lighten-3': '#90CAF9', 'blue-lighten-2': '#64B5F6', 'blue-lighten-1': '#42A5F5', 'blue': '#2196F3', 'blue-darken-1': '#1E88E5', 'blue-darken-2': '#1976D2', 'blue-darken-3': '#1565C0', 'blue-darken-4': '#0D47A1',
  'light-blue-lighten-5': '#E1F5FE', 'light-blue-lighten-4': '#B3E5FC', 'light-blue-lighten-3': '#81D4FA', 'light-blue-lighten-2': '#4FC3F7', 'light-blue-lighten-1': '#29B6F6', 'light-blue': '#03A9F4', 'light-blue-darken-1': '#039BE5', 'light-blue-darken-2': '#0288D1', 'light-blue-darken-3': '#0277BD', 'light-blue-darken-4': '#01579B',
  'cyan-lighten-5': '#E0F7FA', 'cyan-lighten-4': '#B2EBF2', 'cyan-lighten-3': '#80DEEA', 'cyan-lighten-2': '#4DD0E1', 'cyan-lighten-1': '#26C6DA', 'cyan': '#00BCD4', 'cyan-darken-1': '#00ACC1', 'cyan-darken-2': '#0097A7', 'cyan-darken-3': '#00838F', 'cyan-darken-4': '#006064',
  'teal-lighten-5': '#E0F2F1', 'teal-lighten-4': '#B2DFDB', 'teal-lighten-3': '#80CBC4', 'teal-lighten-2': '#4DB6AC', 'teal-lighten-1': '#26A69A', 'teal': '#009688', 'teal-darken-1': '#00897B', 'teal-darken-2': '#00796B', 'teal-darken-3': '#00695C', 'teal-darken-4': '#004D40',
  'green-lighten-5': '#E8F5E9', 'green-lighten-4': '#C8E6C9', 'green-lighten-3': '#A5D6A7', 'green-lighten-2': '#81C784', 'green-lighten-1': '#66BB6A', 'green': '#4CAF50', 'green-darken-1': '#43A047', 'green-darken-2': '#388E3C', 'green-darken-3': '#2E7D32', 'green-darken-4': '#1B5E20',
  'light-green-lighten-5': '#F1F8E9', 'light-green-lighten-4': '#DCEDC8', 'light-green-lighten-3': '#C5E1A5', 'light-green-lighten-2': '#AED581', 'light-green-lighten-1': '#9CCC65', 'light-green': '#8BC34A', 'light-green-darken-1': '#7CB342', 'light-green-darken-2': '#689F38', 'light-green-darken-3': '#558B2F', 'light-green-darken-4': '#33691E',
  'lime-lighten-5': '#F9FBE7', 'lime-lighten-4': '#F0F4C3', 'lime-lighten-3': '#E6EE9C', 'lime-lighten-2': '#DCE775', 'lime-lighten-1': '#D4E157', 'lime': '#CDDC39', 'lime-darken-1': '#C0CA33', 'lime-darken-2': '#AFB42B', 'lime-darken-3': '#9E9D24', 'lime-darken-4': '#827717',
  'yellow-lighten-5': '#FFFDE7', 'yellow-lighten-4': '#FFF9C4', 'yellow-lighten-3': '#FFF59D', 'yellow-lighten-2': '#FFF176', 'yellow-lighten-1': '#FFEE58', 'yellow': '#FFEB3B', 'yellow-darken-1': '#FDD835', 'yellow-darken-2': '#FBC02D', 'yellow-darken-3': '#F9A825', 'yellow-darken-4': '#F57F17',
  'amber-lighten-5': '#FFF8E1', 'amber-lighten-4': '#FFECB3', 'amber-lighten-3': '#FFE082', 'amber-lighten-2': '#FFD54F', 'amber-lighten-1': '#FFCA28', 'amber': '#FFC107', 'amber-darken-1': '#FFB300', 'amber-darken-2': '#FFA000', 'amber-darken-3': '#FF8F00', 'amber-darken-4': '#FF6F00',
  'orange-lighten-5': '#FFF3E0', 'orange-lighten-4': '#FFE0B2', 'orange-lighten-3': '#FFCC80', 'orange-lighten-2': '#FFB74D', 'orange-lighten-1': '#FFA726', 'orange': '#FF9800', 'orange-darken-1': '#FB8C00', 'orange-darken-2': '#F57C00', 'orange-darken-3': '#EF6C00', 'orange-darken-4': '#E65100',
  'deep-orange-lighten-5': '#FBE9E7', 'deep-orange-lighten-4': '#FFCCBC', 'deep-orange-lighten-3': '#FFAB91', 'deep-orange-lighten-2': '#FF8A65', 'deep-orange-lighten-1': '#FF7043', 'deep-orange': '#FF5722', 'deep-orange-darken-1': '#F4511E', 'deep-orange-darken-2': '#E64A19', 'deep-orange-darken-3': '#D84315', 'deep-orange-darken-4': '#BF360C',
  'brown-lighten-5': '#EFEBE9', 'brown-lighten-4': '#D7CCC8', 'brown-lighten-3': '#BCAAA4', 'brown-lighten-2': '#A1887F', 'brown-lighten-1': '#8D6E63', 'brown': '#795548', 'brown-darken-1': '#6D4C41', 'brown-darken-2': '#5D4037', 'brown-darken-3': '#4E342E', 'brown-darken-4': '#3E2723',
  'blue-grey-lighten-5': '#ECEFF1', 'blue-grey-lighten-4': '#CFD8DC', 'blue-grey-lighten-3': '#B0BEC5', 'blue-grey-lighten-2': '#90A4AE', 'blue-grey-lighten-1': '#78909C', 'blue-grey': '#607D8B', 'blue-grey-darken-1': '#546E7A', 'blue-grey-darken-2': '#455A64', 'blue-grey-darken-3': '#37474F', 'blue-grey-darken-4': '#263238',
  'grey-lighten-5': '#FAFAFA', 'grey-lighten-4': '#F5F5F5', 'grey-lighten-3': '#EEEEEE', 'grey-lighten-2': '#E0E0E0', 'grey-lighten-1': '#BDBDBD', 'grey': '#9E9E9E', 'grey-darken-1': '#757575', 'grey-darken-2': '#616161', 'grey-darken-3': '#424242', 'grey-darken-4': '#212121',
  'black': '#000000',
  'white': '#FFFFFF',
  'transparent': '#FFFFFF00'
};

// Create a reverse map for quick lookup (HEX -> name)
const hexToName = Object.fromEntries(Object.entries(vuetifyColors).map(([name, hex]) => [hex.toUpperCase(), name]));

// Filter for base colors (without lighten/darken suffixes)
const baseVuetifyColors = Object.fromEntries(
  Object.entries(vuetifyColors).filter(([name, _]) => {
    return !name.includes('lighten') && !name.includes('darken') && name !== 'transparent';
  })
);

// Create a nested array of swatches for the v-color-picker, containing only base colors
const baseSwatches = [
  Object.values(baseVuetifyColors).slice(0, 5),
  Object.values(baseVuetifyColors).slice(5, 10),
  Object.values(baseVuetifyColors).slice(10, 15),
  Object.values(baseVuetifyColors).slice(15, 20),
];

// Create a nested array of swatches for the v-color-picker
const swatches = [
    ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5'],
    ['#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50'],
    ['#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800'],
    ['#FF5722', '#795548', '#607D8B', '#9E9E9E', '#000000'],
];

/**
 * Converts a hex color string to an RGB object.
 * @param {string} hex - The hex color string (e.g., '#RRGGBB').
 * @returns {{r: number, g: number, b: number}|null}
 */
function hexToRgb(hex) {
  if (!hex) return null;
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
}

const paletteRgb = Object.entries(vuetifyColors).map(([name, hex]) => ({
  name,
  rgb: hexToRgb(hex)
}));

// Pre-calculate RGB values for the base palette for performance.
const basePaletteRgb = Object.entries(baseVuetifyColors).map(([name, hex]) => ({
  name,
  rgb: hexToRgb(hex)
}));

/**
 * Finds the closest Vuetify color name for a given hex string.
 * @param {string} hex - The hex color string.
 * @returns {string|null} The name of the closest color or null.
 */
function findClosestColorName(hex) {
  const targetRgb = hexToRgb(hex);
  if (!targetRgb) return null;

  let minDistance = Infinity;
  let closestName = null;

  for (const color of paletteRgb) {
    if (!color.rgb) continue;

    // Using squared Euclidean distance for efficiency (avoids sqrt)
    const distance = Math.pow(targetRgb.r - color.rgb.r, 2) +
                   Math.pow(targetRgb.g - color.rgb.g, 2) +
                   Math.pow(targetRgb.b - color.rgb.b, 2);

    if (distance < minDistance) {
      minDistance = distance;
      closestName = color.name;
    }
  }
  return closestName;
}

/**
 * Finds the closest Vuetify base color name for a given hex string.
 * @param {string} hex - The hex color string.
 * @returns {string|null} The name of the closest base color or null.
 */
function findClosestBaseColorName(hex) {
  const targetRgb = hexToRgb(hex);
  if (!targetRgb) return null;

  let minDistance = Infinity;
  let closestName = null;

  for (const color of basePaletteRgb) { // Utilise basePaletteRgb
    if (!color.rgb) continue;

    const distance = Math.pow(targetRgb.r - color.rgb.r, 2) +
                   Math.pow(targetRgb.g - color.rgb.g, 2) +
                   Math.pow(targetRgb.b - color.rgb.b, 2);

    if (distance < minDistance) {
      minDistance = distance;
      closestName = color.name;
    }
  }
  return closestName;
}


export function useVuetifyColors() {
  /**
   * Converts a Vuetify color name to its HEX value.
   * @param {string} name The name of the color (e.g., 'red-darken-1').
   * @returns {string} The HEX value or the original name if not found.
   */
  const toHex = (name) => {
    if (name === null || name === undefined) {
      return '#000000'; // Or any other default fallback color
    }
    return vuetifyColors[name] || name;
  };

  /**
   * Converts a HEX color value to its closest Vuetify color name.
   * @param {string} hex The HEX value of the color (e.g., '#D32F2F').
   * @returns {string} The closest Vuetify color name.
   */
  const toName = (hex) => {
    if (!hex) return null;
    // First, check for an exact match for performance and accuracy.
    const upperHex = hex.toUpperCase();
    if (hexToName[upperHex]) {
      return hexToName[upperHex];
    }
    // If no exact match, find the closest color in the palette.
    return findClosestColorName(hex);
  };

  /**
   * Converts a HEX color value to its closest Vuetify base color name.
   * @param {string} hex The HEX value of the color (e.g., '#F44336').
   * @returns {string} The closest Vuetify base color name.
   */
  const toBaseName = (hex) => {
    if (!hex) return null;
    // First, check for an exact match for performance and accuracy.
    const upperHex = hex.toUpperCase();
    // Check if the exact hex matches a base color
    const exactBaseMatch = Object.entries(baseVuetifyColors).find(([name, val]) => val.toUpperCase() === upperHex);
    if (exactBaseMatch) {
      return exactBaseMatch[0];
    }
    // If no exact match, find the closest base color in the palette.
    return findClosestBaseColorName(hex);
  };

  /**
   * Calculates the best contrasting color (black or white) for a given color name.
   * @param {string} colorName The name of the color (e.g., 'red-darken-1').
   * @returns {'black'|'white'}
   */
  const getContrastColor = (colorName) => {
    if (!colorName) return 'black';
    
    const resolvedHex = toHex(colorName);
    if (!resolvedHex || !resolvedHex.startsWith('#')) return 'black';

    const rgb = hexToRgb(resolvedHex);
    if (!rgb) return 'black';

    const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
    return luminance > 0.5 ? 'black' : 'white';
  };

  return {
    toHex,
    toName,
    toBaseName,
    hexToRgb,
    getContrastColor, // Export getContrastColor
    swatches,
    baseSwatches,
    vuetifyColors
  };
}
